name: jawiki louds benchmark

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      dump:
        description: "jawiki dump directory (e.g. latest or 20251201)"
        required: false
        default: "latest"
      limit:
        description: "Optional limit of titles to process (0 = no limit)"
        required: false
        default: "0"

jobs:
  build-and-benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve variables
        shell: bash
        run: |
          set -euo pipefail

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            DUMP="${{ github.event.inputs.dump }}"
            LIMIT="${{ github.event.inputs.limit }}"
          else
            # tag push の場合は inputs が存在しないため固定
            DUMP="latest"
            LIMIT="0"
          fi

          echo "DUMP=$DUMP" >> "$GITHUB_ENV"
          echo "LIMIT=$LIMIT" >> "$GITHUB_ENV"

          if [[ "${GITHUB_REF:-}" == refs/tags/* ]]; then
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            echo "TAG_NAME=$TAG_NAME" >> "$GITHUB_ENV"
          else
            echo "TAG_NAME=" >> "$GITHUB_ENV"
          fi

          echo "Resolved:"
          echo "  DUMP=$DUMP"
          echo "  LIMIT=$LIMIT"
          echo "  TAG_NAME=${TAG_NAME:-}"

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ zlib1g-dev time

      - name: Configure (CMake)
        run: |
          cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release

      - name: Build
        run: |
          cmake --build build

      - name: Verify tools exist
        shell: bash
        run: |
          set -euxo pipefail
          ls -lh build || true
          test -x build/jawiki_build_utf16
          test -x build/louds_query_utf16 || true

      - name: Run unit tests
        run: |
          ctest --test-dir build --output-on-failure

      - name: Download jawiki all-titles (ns0)
        run: |
          set -euxo pipefail
          mkdir -p data
          BASE="https://dumps.wikimedia.org/jawiki/${DUMP}"
          FILE="jawiki-${DUMP}-all-titles-in-ns0.gz"
          URL="${BASE}/${FILE}"

          echo "Downloading: ${URL}"
          curl -L --fail --retry 10 --retry-all-errors --connect-timeout 30 --max-time 3600 \
            -o "data/${FILE}" "${URL}"

          ls -lh "data/${FILE}"

      - name: Build LOUDS (UTF-16) from jawiki titles and measure time
        run: |
          set -euxo pipefail
          mkdir -p out

          FILE="jawiki-${DUMP}-all-titles-in-ns0.gz"

          # /usr/bin/time の結果を out/time.txt に、プログラムの統計を out/metrics.json に出力
          /usr/bin/time -v \
            build/jawiki_build_utf16 \
              --input "data/${FILE}" \
              --out-dir out \
              --prefix "jawiki_${DUMP}" \
              --limit "${LIMIT}" \
            2> out/time.txt

          echo "===== metrics.json ====="
          cat out/metrics.json
          echo "===== time.txt (tail) ====="
          tail -n 50 out/time.txt

      # Tag push のときは GitHub Release に assets を添付
      - name: Upload assets to GitHub Release (tag push only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            out/*.bin
            out/metrics.json
            out/time.txt
          fail_on_unmatched_files: true
          generate_release_notes: true
          name: "jawiki louds benchmark (${{ env.DUMP }})"

      # workflow_dispatch のときは従来どおり Actions artifact にアップロード
      - name: Upload artifacts (workflow_dispatch only)
        if: ${{ !startsWith(github.ref, 'refs/tags/') }}
        uses: actions/upload-artifact@v4
        with:
          name: jawiki_louds_${{ env.DUMP }}
          path: |
            out/*.bin
            out/metrics.json
            out/time.txt
          if-no-files-found: error
